(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[398],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},9840:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ComponentMod:()=>U,default:()=>N});var r={};o.r(r),o.d(r,{GET:()=>y,POST:()=>O,preferredRegion:()=>I,runtime:()=>E});var a={};o.r(a),o.d(a,{headerHooks:()=>w,originalPathname:()=>C,patchFetch:()=>R,requestAsyncStorage:()=>_,routeModule:()=>b,serverHooks:()=>k,staticGenerationAsyncStorage:()=>P,staticGenerationBailout:()=>T});var s=o(7875),n=o(8381),i=o(2251),p=o(9845),l=o(9579),c=o(7736),d=o(1480),u=o(572),h=o(5577),g=o(413);let m=(0,l.g)();async function v(e){let t=new AbortController;var o,r,a,s="";m.isAzure?(a=e.headers.get("Authorization")?.trim().replaceAll("Bearer ","").trim()??"",s="api-key"):(a=e.headers.get("Authorization")??"",s="Authorization");let n=`${e.nextUrl.pathname}${e.nextUrl.search}`.replaceAll("/api/openai/",""),i=m.azureUrl||m.baseUrl||c.Bi;i.startsWith("http")||(i=`https://${i}`),i.endsWith("/")&&(i=i.slice(0,-1)),console.log("[Proxy] ",n),console.log("[Base Url]",i);let p=setTimeout(()=>{t.abort()},6e5);if(m.isAzure){if(!m.azureApiVersion)return u.xk.json({error:!0,message:"missing AZURE_API_VERSION in server env vars"});o=n,r=m.azureApiVersion,o=o.replaceAll("v1/",""),n=o+=`${o.includes("?")?"&":"?"}api-version=${r}`}let l=`${i}/${n}`,d={headers:{"Content-Type":"application/json","Cache-Control":"no-store",[s]:a,...m.openaiOrgId&&{"OpenAI-Organization":m.openaiOrgId}},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(m.customModels&&e.body)try{let t=(0,g.RM)(c.Fv,m.customModels),o=await e.text();d.body=o;let r=JSON.parse(o);if(!1===t[r?.model??""].available)return u.xk.json({error:!0,message:`you are not allowed to use ${r?.model} model`},{status:403})}catch(e){console.error("[OpenAI] gpt4 filter",e)}try{let e=await fetch(l,d),t=e.headers.get("OpenAI-Organization");m.openaiOrgId&&""!==m.openaiOrgId.trim()?console.log("[Org ID]",t):console.log("[Org ID] is not set up.");let o=new Headers(e.headers);return o.delete("www-authenticate"),o.set("X-Accel-Buffering","no"),m.openaiOrgId&&""!==m.openaiOrgId.trim()||o.delete("OpenAI-Organization"),o.delete("content-encoding"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:o})}finally{clearTimeout(p)}}let A=new Set(Object.values(c.mX));async function f(e,{params:t}){if(console.log("[OpenAI Route] params ",t),"OPTIONS"===e.method)return u.xk.json({body:"OK"},{status:200});let o=t.path.join("/");if(!A.has(o))return console.log("[OpenAI Route] forbidden path ",o),u.xk.json({error:!0,msg:"you are not allowed to request "+o},{status:403});let r=(0,h.I)(e,c.k8.GPT);if(r.error)return u.xk.json(r,{status:401});try{let t=await v(e);if(o===c.mX.ListModelPath&&200===t.status){var a;let e=(a=await t.json(),(0,l.g)().disableGPT4&&(a.data=a.data.filter(e=>!e.id.startsWith("gpt-4"))),a);return u.xk.json(e,{status:t.status})}return t}catch(e){return console.error("[OpenAI] ",e),u.xk.json((0,d.B)(e))}}let y=f,O=f,E="edge",I=["arn1","bom1","cdg1","cle1","cpt1","dub1","fra1","gru1","hnd1","iad1","icn1","kix1","lhr1","pdx1","sfo1","sin1","syd1"],b=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/openai/[...path]/route",pathname:"/api/openai/[...path]",filename:"route",bundlePath:"app/api/openai/[...path]/route"},resolvedPagePath:"/Volumes/D/github/ChatGPT-Next-Web/app/api/openai/[...path]/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:_,staticGenerationAsyncStorage:P,serverHooks:k,headerHooks:w,staticGenerationBailout:T}=b,C="/api/openai/[...path]/route";function R(){return(0,p.XH)({serverHooks:k,staticGenerationAsyncStorage:P})}let U=a,N=s.a.wrap(b)},5577:(e,t,o)=>{"use strict";o.d(t,{I:()=>i});var r=o(9579),a=o(5045),s=o.n(a),n=o(7736);function i(e,t){let{accessCode:o,apiKey:a}=function(e){let t=e.trim().replaceAll("Bearer ","").trim(),o=!t.startsWith(n.TW);return{accessCode:o?"":t.slice(n.TW.length),apiKey:o?t:""}}(e.headers.get("Authorization")??""),i=s().hash(o??"").trim(),p=(0,r.g)();if(console.log("[Auth] allowed hashed codes: ",[...p.codes]),console.log("[Auth] got access code:",o),console.log("[Auth] hashed access code:",i),console.log("[User IP] ",function(e){let t=e.ip??e.headers.get("x-real-ip"),o=e.headers.get("x-forwarded-for");return!t&&o&&(t=o.split(",").at(0)??""),t}(e)),console.log("[Time] ",new Date().toLocaleString()),p.needCode&&!p.codes.has(i)&&!a)return{error:!0,msg:o?"wrong access code":"empty access code"};if(p.hideUserApiKey&&a)return{error:!0,msg:"you are not allowed to access with your own api key"};if(a)console.log("[Auth] use user api key");else{let o;let a=(0,r.g)();switch(t){case n.k8.GeminiPro:o=a.googleApiKey;break;case n.k8.Claude:o=a.anthropicApiKey;break;case n.k8.GPT:default:o=a.isAzure?a.azureApiKey:a.apiKey}o?(console.log("[Auth] use system api key"),e.headers.set("Authorization",`Bearer ${o}`)):console.log("[Auth] admin did not provide an api key")}return{error:!1}}},9579:(e,t,o)=>{"use strict";o.d(t,{g:()=>p});var r=o(5045),a=o.n(r),s=o(7736);let n=function(){let e=process.env.CODE;try{let t=(e?.split(",")??[]).filter(e=>!!e).map(e=>a().hash(e.trim()));return new Set(t)}catch(e){return new Set}}();function i(e){let t=(e??"").split(",").map(e=>e.trim()),o=Math.floor(Math.random()*t.length),r=t[o];return r&&console.log(`[Server Config] using ${o+1} of ${t.length} api key - ${r}`),r}let p=()=>{if("undefined"==typeof process)throw Error("[Server Config] you are importing a nodejs-only module outside of nodejs");let e=!!process.env.DISABLE_GPT4,t=process.env.CUSTOM_MODELS??"",o=process.env.DEFAULT_MODEL??"";e&&(t&&(t+=","),t+=s.Fv.filter(e=>e.name.startsWith("gpt-4")).map(e=>"-"+e.name).join(","),o.startsWith("gpt-4")&&(o=""));let r=!!process.env.AZURE_URL,a=!!process.env.GOOGLE_API_KEY,p=!!process.env.ANTHROPIC_API_KEY,l=(process.env.WHITE_WEBDEV_ENDPOINTS??"").split(",");return{baseUrl:process.env.BASE_URL,apiKey:i(process.env.OPENAI_API_KEY),openaiOrgId:process.env.OPENAI_ORG_ID,isAzure:r,azureUrl:process.env.AZURE_URL,azureApiKey:i(process.env.AZURE_API_KEY),azureApiVersion:process.env.AZURE_API_VERSION,isGoogle:a,googleApiKey:i(process.env.GOOGLE_API_KEY),googleUrl:process.env.GOOGLE_URL,isAnthropic:p,anthropicApiKey:i(process.env.ANTHROPIC_API_KEY),anthropicApiVersion:process.env.ANTHROPIC_API_VERSION,anthropicUrl:process.env.ANTHROPIC_URL,gtmId:process.env.GTM_ID,needCode:n.size>0,code:process.env.CODE,codes:n,proxyUrl:process.env.PROXY_URL,isVercel:!!process.env.VERCEL,hideUserApiKey:!!process.env.HIDE_USER_API_KEY,disableGPT4:e,hideBalanceQuery:!process.env.ENABLE_BALANCE_QUERY,disableFastLink:!!process.env.DISABLE_FAST_LINK,customModels:t,defaultModel:o,allowedWebDevEndpoints:l}}},7736:(e,t,o)=>{"use strict";var r,a,s,n,i,p,l;o.d(t,{Bi:()=>c,Fv:()=>A,Hm:()=>u,L:()=>a,NU:()=>f,TW:()=>h,Uf:()=>g,YU:()=>m,k8:()=>l,mX:()=>v,y3:()=>d});let c="https://api.openai.com",d="https://api.anthropic.com",u="https://generativelanguage.googleapis.com/";!function(e){e.Home="/",e.Chat="/chat",e.Settings="/settings",e.NewChat="/new-chat",e.Masks="/masks",e.Auth="/auth"}(r||(r={})),function(e){e.Cors="",e.OpenAI="/api/openai",e.Anthropic="/api/anthropic"}(a||(a={})),function(e){e.AppBody="app-body",e.CustomModel="custom-model"}(s||(s={})),function(e){e.Masks="masks.json",e.Prompts="prompts.json"}(n||(n={})),function(e){e.Chat="chat-next-web-store",e.Access="access-control",e.Config="app-config",e.Mask="mask-store",e.Prompt="prompt-store",e.Update="chat-update",e.Sync="sync"}(i||(i={}));let h="nk-",g="chatgpt-next-web";!function(e){e.OpenAI="OpenAI",e.Azure="Azure",e.Google="Google",e.Anthropic="Anthropic"}(p||(p={})),function(e){e.GPT="GPT",e.GeminiPro="GeminiPro",e.Claude="Claude"}(l||(l={}));let m={ChatPath:"v1/messages",ChatPath1:"v1/complete",ExampleEndpoint:"https://api.anthropic.com",Vision:"2023-06-01"},v={ChatPath:"v1/chat/completions",UsagePath:"dashboard/billing/usage",SubsPath:"dashboard/billing/subscription",ListModelPath:"v1/models"},A=[...["gpt-3.5-turbo","gpt-3.5-turbo-1106","gpt-3.5-turbo-0125","gpt-4","gpt-4-0613","gpt-4-32k","gpt-4-32k-0613","gpt-4-turbo","gpt-4-turbo-preview","gpt-4o","gpt-4o-2024-05-13","gpt-4-vision-preview","gpt-4-turbo-2024-04-09"].map(e=>({name:e,available:!0,provider:{id:"openai",providerName:"OpenAI",providerType:"openai"}})),...["gemini-1.0-pro","gemini-1.5-pro-latest","gemini-1.5-flash-latest","gemini-pro-vision"].map(e=>({name:e,available:!0,provider:{id:"google",providerName:"Google",providerType:"google"}})),...["claude-instant-1.2","claude-2.0","claude-2.1","claude-3-sonnet-20240229","claude-3-opus-20240229","claude-3-haiku-20240307"].map(e=>({name:e,available:!0,provider:{id:"anthropic",providerName:"Anthropic",providerType:"anthropic"}}))],f=["https://dav.jianguoyun.com/dav/","https://dav.dropdav.com/","https://dav.box.com/dav","https://nanao.teracloud.jp/dav/","https://bora.teracloud.jp/dav/","https://webdav.4shared.com/","https://dav.idrivesync.com","https://webdav.yandex.com","https://app.koofr.net/dav/Koofr"]},1480:(e,t,o)=>{"use strict";function r(e){let t=e;return("string"!=typeof e&&(e=JSON.stringify(e,null,"  ")),"{}"===e)?t.toString():e.startsWith("```json")?e:["```json",e,"```"].join("\n")}o.d(t,{B:()=>r})},413:(e,t,o)=>{"use strict";o.d(t,{RM:()=>a});let r=e=>({id:e,providerName:"",providerType:"custom"});function a(e,t){let o={};return e.forEach(e=>{o[e.name]={...e,displayName:e.name}}),t.split(",").filter(e=>!!e&&e.length>0).forEach(e=>{let t=!e.startsWith("-"),[a,s]=(e.startsWith("+")||e.startsWith("-")?e.slice(1):e).split("=");"all"===a?Object.values(o).forEach(e=>e.available=t):o[a]={name:a,displayName:s||a,available:t,provider:o[a]?.provider??r(a)}}),o}}},e=>{var t=t=>e(e.s=t);e.O(0,[297,45],()=>t(9840));var o=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/openai/[...path]/route"]=o}]);
//# sourceMappingURL=route.js.map