(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[163],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},4057:(e,t,r)=>{"use strict";r.r(t),r.d(t,{ComponentMod:()=>S,default:()=>U});var o={};r.r(o),r.d(o,{GET:()=>w,POST:()=>x,preferredRegion:()=>A,runtime:()=>b});var a={};r.r(a),r.d(a,{headerHooks:()=>_,originalPathname:()=>v,patchFetch:()=>O,requestAsyncStorage:()=>P,routeModule:()=>C,serverHooks:()=>R,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>j});var n=r(7875),i=r(8381),s=r(2251),l=r(9845),u=r(9579),c=r(7736),p=r(1480),h=r(572),d=r(5577),f=r(413),g=r(752);let m=new Set([c.YU.ChatPath,c.YU.ChatPath1]);async function y(e,{params:t}){if(console.log("[Anthropic Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let r=t.path.join("/");if(!m.has(r))return console.log("[Anthropic Route] forbidden path ",r),h.xk.json({error:!0,msg:"you are not allowed to request "+r},{status:403});let o=(0,d.I)(e,c.k8.Claude);if(o.error)return h.xk.json(o,{status:401});try{return await T(e)}catch(e){return console.error("[Anthropic] ",e),h.xk.json((0,p.B)(e))}}let w=y,x=y,b="edge",A=["arn1","bom1","cdg1","cle1","cpt1","dub1","fra1","gru1","hnd1","iad1","icn1","kix1","lhr1","pdx1","sfo1","sin1","syd1"],k=(0,u.g)();async function T(e){let t=new AbortController,r="x-api-key",o=e.headers.get(r)||e.headers.get("Authorization")?.replaceAll("Bearer ","").trim()||k.anthropicApiKey||"",a=`${e.nextUrl.pathname}`.replaceAll(c.L.Anthropic,""),n=k.anthropicUrl||k.baseUrl||c.y3;n.startsWith("http")||(n=`https://${n}`),n.endsWith("/")&&(n=n.slice(0,-1)),console.log("[Proxy] ",a),console.log("[Base Url]",n);let i=setTimeout(()=>{t.abort()},6e5),s=(0,g.z)(`${n}${a}`),l={headers:{"Content-Type":"application/json","Cache-Control":"no-store",[r]:o,"anthropic-version":e.headers.get("anthropic-version")||k.anthropicApiVersion||c.YU.Vision},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(k.customModels&&e.body)try{let t=await e.text();l.body=t;let r=JSON.parse(t);if((0,f.pw)(k.customModels,r?.model,c.UT.Anthropic))return h.xk.json({error:!0,message:`you are not allowed to use ${r?.model} model`},{status:403})}catch(e){console.error("[Anthropic] filter",e)}try{let e=await fetch(s,l),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(i)}}let C=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/anthropic/[...path]/route",pathname:"/api/anthropic/[...path]",filename:"route",bundlePath:"app/api/anthropic/[...path]/route"},resolvedPagePath:"/Volumes/D/github/ChatGPT-Next-Web/app/api/anthropic/[...path]/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:P,staticGenerationAsyncStorage:E,serverHooks:R,headerHooks:_,staticGenerationBailout:j}=C,v="/api/anthropic/[...path]/route";function O(){return(0,l.XH)({serverHooks:R,staticGenerationAsyncStorage:E})}let S=a,U=n.a.wrap(C)},752:(e,t,r)=>{"use strict";function o(e){let t=e.split("/");if("gateway.ai.cloudflare.com"==t[2]){if("azure-openai"==t[6])return t.slice(0,8).concat(t.slice(-3)).join("/");if("openai"==t[6]||"anthropic"==t[6])return t.slice(0,7).concat(t.slice(-2)).join("/")}return e}r.d(t,{z:()=>o})}},e=>{var t=t=>e(e.s=t);e.O(0,[297,45,744],()=>t(4057));var r=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/anthropic/[...path]/route"]=r}]);
//# sourceMappingURL=route.js.map