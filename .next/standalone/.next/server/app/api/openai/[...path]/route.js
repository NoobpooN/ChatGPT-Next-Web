(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[398],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},1913:(e,t,a)=>{"use strict";a.r(t),a.d(t,{ComponentMod:()=>v,default:()=>j});var o={};a.r(o),a.d(o,{GET:()=>O,POST:()=>y,preferredRegion:()=>A,runtime:()=>x});var r={};a.r(r),a.d(r,{headerHooks:()=>z,originalPathname:()=>P,patchFetch:()=>U,requestAsyncStorage:()=>I,routeModule:()=>w,serverHooks:()=>k,staticGenerationAsyncStorage:()=>b,staticGenerationBailout:()=>T});var n=a(7875),s=a(8381),i=a(2251),l=a(9845),p=a(9579),u=a(7736),d=a(1480),c=a(572),h=a(5577),g=a(6718);let f=new Set(Object.values(u.mX));async function m(e,{params:t}){if(console.log("[OpenAI Route] params ",t),"OPTIONS"===e.method)return c.xk.json({body:"OK"},{status:200});let a=t.path.join("/");if(!f.has(a))return console.log("[OpenAI Route] forbidden path ",a),c.xk.json({error:!0,msg:"you are not allowed to request "+a},{status:403});let o=(0,h.I)(e,u.k8.GPT);if(o.error)return c.xk.json(o,{status:401});try{let t=await (0,g.L)(e);if(a===u.mX.ListModelPath&&200===t.status){var r;let e=(r=await t.json(),(0,p.g)().disableGPT4&&(r.data=r.data.filter(e=>!e.id.startsWith("gpt-4"))),r);return c.xk.json(e,{status:t.status})}return t}catch(e){return console.error("[OpenAI] ",e),c.xk.json((0,d.B)(e))}}let O=m,y=m,x="edge",A=["arn1","bom1","cdg1","cle1","cpt1","dub1","fra1","gru1","hnd1","iad1","icn1","kix1","lhr1","pdx1","sfo1","sin1","syd1"],w=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/openai/[...path]/route",pathname:"/api/openai/[...path]",filename:"route",bundlePath:"app/api/openai/[...path]/route"},resolvedPagePath:"/Volumes/D/github/ChatGPT-Next-Web/app/api/openai/[...path]/route.ts",nextConfigOutput:"standalone",userland:o}),{requestAsyncStorage:I,staticGenerationAsyncStorage:b,serverHooks:k,headerHooks:z,staticGenerationBailout:T}=w,P="/api/openai/[...path]/route";function U(){return(0,l.XH)({serverHooks:k,staticGenerationAsyncStorage:b})}let v=r,j=n.a.wrap(w)},6718:(e,t,a)=>{"use strict";a.d(t,{L:()=>p});var o=a(572),r=a(9579),n=a(7736),s=a(413),i=a(752);let l=(0,r.g)();async function p(e){let t=new AbortController,a=e.nextUrl.pathname.includes("azure/deployments");var r,p="";a?(r=e.headers.get("Authorization")?.trim().replaceAll("Bearer ","").trim()??"",p="api-key"):(r=e.headers.get("Authorization")??"",p="Authorization");let u=`${e.nextUrl.pathname}${e.nextUrl.search}`.replaceAll("/api/openai/",""),d=(a?l.azureUrl:l.baseUrl)||n.Bi;d.startsWith("http")||(d=`https://${d}`),d.endsWith("/")&&(d=d.slice(0,-1)),console.log("[Proxy] ",u),console.log("[Base Url]",d);let c=setTimeout(()=>{t.abort()},6e5);if(a){let t=e?.nextUrl?.searchParams?.get("api-version")||l.azureApiVersion;if(d=d.split("/deployments").shift(),u=`${e.nextUrl.pathname.replaceAll("/api/azure/","")}?api-version=${t}`,l.customModels&&l.azureUrl){let e=u.split("/")[1],t="";l.customModels.split(",").filter(t=>!!t&&!t.startsWith("-")&&t.includes(e)).forEach(e=>{let[a,o]=e.split("="),[r,n]=a.split("@");if("azure"===n&&!o){let[e,a]=(l?.azureUrl??"").split("deployments/");a&&(t=a)}}),t&&(console.log("[Replace with DeployId",t),u=u.replaceAll(e,t))}}let h=(0,i.z)(`${d}/${u}`);console.log("fetchUrl",h);let g={headers:{"Content-Type":"application/json","Cache-Control":"no-store",[p]:r,...l.openaiOrgId&&{"OpenAI-Organization":l.openaiOrgId}},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(l.customModels&&e.body)try{let t=await e.text();g.body=t;let a=JSON.parse(t);if((0,s.pw)(l.customModels,a?.model,n.UT.OpenAI)||(0,s.pw)(l.customModels,a?.model,n.UT.Azure))return o.xk.json({error:!0,message:`you are not allowed to use ${a?.model} model`},{status:403})}catch(e){console.error("[OpenAI] gpt4 filter",e)}try{let e=await fetch(h,g),t=e.headers.get("OpenAI-Organization");l.openaiOrgId&&""!==l.openaiOrgId.trim()?console.log("[Org ID]",t):console.log("[Org ID] is not set up.");let a=new Headers(e.headers);return a.delete("www-authenticate"),a.set("X-Accel-Buffering","no"),l.openaiOrgId&&""!==l.openaiOrgId.trim()||a.delete("OpenAI-Organization"),a.delete("content-encoding"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:a})}finally{clearTimeout(c)}}},752:(e,t,a)=>{"use strict";function o(e){let t=e.split("/");if("gateway.ai.cloudflare.com"==t[2]){if("azure-openai"==t[6])return t.slice(0,8).concat(t.slice(-3)).join("/");if("openai"==t[6]||"anthropic"==t[6])return t.slice(0,7).concat(t.slice(-2)).join("/")}return e}a.d(t,{z:()=>o})}},e=>{var t=t=>e(e.s=t);e.O(0,[297,45,744],()=>t(1913));var a=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/openai/[...path]/route"]=a}]);
//# sourceMappingURL=route.js.map