(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[919],{2067:e=>{"use strict";e.exports=require("node:async_hooks")},6195:e=>{"use strict";e.exports=require("node:buffer")},5842:(e,t,o)=>{"use strict";o.r(t),o.d(t,{ComponentMod:()=>en,default:()=>el});var r={};o.r(r),o.d(r,{GET:()=>J,POST:()=>q,preferredRegion:()=>V,runtime:()=>F});var a={};o.r(a),o.d(a,{headerHooks:()=>eo,originalPathname:()=>ea,patchFetch:()=>es,requestAsyncStorage:()=>Z,routeModule:()=>Q,serverHooks:()=>et,staticGenerationAsyncStorage:()=>ee,staticGenerationBailout:()=>er});var s=o(7875),n=o(8381),l=o(2251),i=o(9845),u=o(7736),c=o(9579),d=o(1480),h=o(572),p=o(5577);let y={val:-1e3,cache:new Map,next:e=>{if(y.cache.has(e))return y.cache.get(e);{let t=y.val++;return y.cache.set(e,t),t}}},m=e=>({id:e.toLowerCase(),providerName:e,providerType:"custom",sorted:y.next(e)});function f(e,t,o){let r=`${t}@${o}`,a=function(e,t){let o={};return e.forEach(e=>{o[`${e.name}@${e?.provider?.id}`]={...e,displayName:e.name}}),t.split(",").filter(e=>!!e&&e.length>0).forEach(e=>{let t=!e.startsWith("-"),[r,a]=(e.startsWith("+")||e.startsWith("-")?e.slice(1):e).split("=");if("all"===r)Object.values(o).forEach(e=>e.available=t);else{let[e,s]=r.split("@"),n=0;for(let l in o){let[i,u]=l.split("@");e==i&&(void 0===s||s===u)&&(n+=1,o[l].available=t,"bytedance"===u&&([r,a]=[a,i],o[l].name=r),a&&(o[l].displayName=a))}if(0===n){let[e,s]=r.split("@"),n=m(s||e);a&&"ByteDance"==n.providerName&&([e,a]=[a,e]),o[`${e}@${n?.id}`]={name:e,displayName:a||e,available:t,provider:n,sorted:y.next(`${e}@${n?.id}`)}}}}),o}(u.Fv,e);return a[r]?.available===!1}function g(e){let t=e.split("/");if("gateway.ai.cloudflare.com"==t[2]){if("azure-openai"==t[6])return t.slice(0,8).concat(t.slice(-3)).join("/");if("openai"==t[6]||"anthropic"==t[6])return t.slice(0,7).concat(t.slice(-2)).join("/")}return e}let b=(0,c.g)();async function x(e){let t=new AbortController,o=e.nextUrl.pathname.includes("azure/deployments");var r,a="";o?(r=e.headers.get("Authorization")?.trim().replaceAll("Bearer ","").trim()??"",a="api-key"):(r=e.headers.get("Authorization")??"",a="Authorization");let s=`${e.nextUrl.pathname}${e.nextUrl.search}`.replaceAll("/api/openai/",""),n=(o?b.azureUrl:b.baseUrl)||u.Bi;n.startsWith("http")||(n=`https://${n}`),n.endsWith("/")&&(n=n.slice(0,-1)),console.log("[Proxy] ",s),console.log("[Base Url]",n);let l=setTimeout(()=>{t.abort()},6e5);if(o){let t=e?.nextUrl?.searchParams?.get("api-version")||b.azureApiVersion;if(n=n.split("/deployments").shift(),s=`${e.nextUrl.pathname.replaceAll("/api/azure/","")}?api-version=${t}`,b.customModels&&b.azureUrl){let e=s.split("/")[1],t="";b.customModels.split(",").filter(t=>!!t&&!t.startsWith("-")&&t.includes(e)).forEach(e=>{let[o,r]=e.split("="),[a,s]=o.split("@");if("azure"===s&&!r){let[e,o]=(b?.azureUrl??"").split("deployments/");o&&(t=o)}}),t&&(console.log("[Replace with DeployId",t),s=s.replaceAll(e,t))}}let i=g(`${n}/${s}`);console.log("fetchUrl",i);let c={headers:{"Content-Type":"application/json","Cache-Control":"no-store",[a]:r,...b.openaiOrgId&&{"OpenAI-Organization":b.openaiOrgId}},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(b.customModels&&e.body)try{let t=await e.text();c.body=t;let o=JSON.parse(t);if(f(b.customModels,o?.model,u.UT.OpenAI)||f(b.customModels,o?.model,u.UT.Azure))return h.xk.json({error:!0,message:`you are not allowed to use ${o?.model} model`},{status:403})}catch(e){console.error("[OpenAI] gpt4 filter",e)}try{let e=await fetch(i,c),t=e.headers.get("OpenAI-Organization");b.openaiOrgId&&""!==b.openaiOrgId.trim()?console.log("[Org ID]",t):console.log("[Org ID] is not set up.");let o=new Headers(e.headers);return o.delete("www-authenticate"),o.set("X-Accel-Buffering","no"),b.openaiOrgId&&""!==b.openaiOrgId.trim()||o.delete("OpenAI-Organization"),o.delete("content-encoding"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:o})}finally{clearTimeout(l)}}let w=new Set(Object.values(u.mX));async function A(e,{params:t}){if(console.log("[OpenAI Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=t.path.join("/");if(!w.has(o))return console.log("[OpenAI Route] forbidden path ",o),h.xk.json({error:!0,msg:"you are not allowed to request "+o},{status:403});let r=(0,p.I)(e,u.k8.GPT);if(r.error)return h.xk.json(r,{status:401});try{let t=await x(e);if(o===u.mX.ListModelPath&&200===t.status){var a;let e=(a=await t.json(),(0,c.g)().disableGPT4&&(a.data=a.data.filter(e=>!e.id.startsWith("gpt-4")||e.id.startsWith("gpt-4o-mini"))),a);return h.xk.json(e,{status:t.status})}return t}catch(e){return console.error("[OpenAI] ",e),h.xk.json((0,d.B)(e))}}async function T(e,{params:t}){if(console.log("[Azure Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});t.path.join("/");let o=(0,p.I)(e,u.k8.GPT);if(o.error)return h.xk.json(o,{status:401});try{return await x(e)}catch(e){return console.error("[Azure] ",e),h.xk.json((0,d.B)(e))}}let k=(0,c.g)();async function O(e,{params:t}){if(console.log("[Google Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=(0,p.I)(e,u.k8.GeminiPro);if(o.error)return h.xk.json(o,{status:401});let r=(e.headers.get("Authorization")??"").trim().replaceAll("Bearer ","").trim()||k.googleApiKey;if(!r)return h.xk.json({error:!0,message:"missing GOOGLE_API_KEY in server env vars"},{status:401});try{return await $(e,r)}catch(e){return console.error("[Google] ",e),h.xk.json((0,d.B)(e))}}async function $(e,t){let o=new AbortController,r=k.googleUrl||u.Hm,a=`${e.nextUrl.pathname}`.replaceAll(u.L.Google,"");r.startsWith("http")||(r=`https://${r}`),r.endsWith("/")&&(r=r.slice(0,-1)),console.log("[Proxy] ",a),console.log("[Base Url]",r);let s=setTimeout(()=>{o.abort()},6e5),n=`${r}${a}?key=${t}${e?.nextUrl?.searchParams?.get("alt")==="sse"?"&alt=sse":""}`;console.log("[Fetch Url] ",n);let l={headers:{"Content-Type":"application/json","Cache-Control":"no-store"},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:o.signal};try{let e=await fetch(n,l),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(s)}}let j=new Set([u.YU.ChatPath,u.YU.ChatPath1]);async function I(e,{params:t}){if(console.log("[Anthropic Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=t.path.join("/");if(!j.has(o))return console.log("[Anthropic Route] forbidden path ",o),h.xk.json({error:!0,msg:"you are not allowed to request "+o},{status:403});let r=(0,p.I)(e,u.k8.Claude);if(r.error)return h.xk.json(r,{status:401});try{return await B(e)}catch(e){return console.error("[Anthropic] ",e),h.xk.json((0,d.B)(e))}}let U=(0,c.g)();async function B(e){let t=new AbortController,o="x-api-key",r=e.headers.get(o)||e.headers.get("Authorization")?.replaceAll("Bearer ","").trim()||U.anthropicApiKey||"",a=`${e.nextUrl.pathname}`.replaceAll(u.L.Anthropic,""),s=U.anthropicUrl||U.baseUrl||u.y3;s.startsWith("http")||(s=`https://${s}`),s.endsWith("/")&&(s=s.slice(0,-1)),console.log("[Proxy] ",a),console.log("[Base Url]",s);let n=setTimeout(()=>{t.abort()},6e5),l=g(`${s}${a}`),i={headers:{"Content-Type":"application/json","Cache-Control":"no-store",[o]:r,"anthropic-version":e.headers.get("anthropic-version")||U.anthropicApiVersion||u.YU.Vision},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(U.customModels&&e.body)try{let t=await e.text();i.body=t;let o=JSON.parse(t);if(f(U.customModels,o?.model,u.UT.Anthropic))return h.xk.json({error:!0,message:`you are not allowed to use ${o?.model} model`},{status:403})}catch(e){console.error("[Anthropic] filter",e)}try{let e=await fetch(l,i),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(n)}}async function v(e,t){let o=await fetch(`${u.FR}?grant_type=client_credentials&client_id=${e}&client_secret=${t}`,{method:"POST",mode:"cors"});return await o.json()}let S=(0,c.g)();async function P(e,{params:t}){if(console.log("[Baidu Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=(0,p.I)(e,u.k8.Ernie);if(o.error)return h.xk.json(o,{status:401});if(!S.baiduApiKey||!S.baiduSecretKey)return h.xk.json({error:!0,message:"missing BAIDU_API_KEY or BAIDU_SECRET_KEY in server env vars"},{status:401});try{return await C(e)}catch(e){return console.error("[Baidu] ",e),h.xk.json((0,d.B)(e))}}async function C(e){let t=new AbortController,o=`${e.nextUrl.pathname}`.replaceAll(u.L.Baidu,""),r=S.baiduUrl||u.n9;r.startsWith("http")||(r=`https://${r}`),r.endsWith("/")&&(r=r.slice(0,-1)),console.log("[Proxy] ",o),console.log("[Base Url]",r);let a=setTimeout(()=>{t.abort()},6e5),{access_token:s}=await v(S.baiduApiKey,S.baiduSecretKey),n=`${r}${o}?access_token=${s}`,l={headers:{"Content-Type":"application/json"},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(S.customModels&&e.body)try{let t=await e.text();l.body=t;let o=JSON.parse(t);if(f(S.customModels,o?.model,u.UT.Baidu))return h.xk.json({error:!0,message:`you are not allowed to use ${o?.model} model`},{status:403})}catch(e){console.error("[Baidu] filter",e)}try{let e=await fetch(n,l),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(a)}}let R=(0,c.g)();async function z(e,{params:t}){if(console.log("[ByteDance Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=(0,p.I)(e,u.k8.Doubao);if(o.error)return h.xk.json(o,{status:401});try{return await M(e)}catch(e){return console.error("[ByteDance] ",e),h.xk.json((0,d.B)(e))}}async function M(e){let t=new AbortController,o=`${e.nextUrl.pathname}`.replaceAll(u.L.ByteDance,""),r=R.bytedanceUrl||u.ik;r.startsWith("http")||(r=`https://${r}`),r.endsWith("/")&&(r=r.slice(0,-1)),console.log("[Proxy] ",o),console.log("[Base Url]",r);let a=setTimeout(()=>{t.abort()},6e5),s=`${r}${o}`,n={headers:{"Content-Type":"application/json",Authorization:e.headers.get("Authorization")??""},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(R.customModels&&e.body)try{let t=await e.text();n.body=t;let o=JSON.parse(t);if(f(R.customModels,o?.model,u.UT.ByteDance))return h.xk.json({error:!0,message:`you are not allowed to use ${o?.model} model`},{status:403})}catch(e){console.error("[ByteDance] filter",e)}try{let e=await fetch(s,n),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(a)}}let N=(0,c.g)();async function W(e,{params:t}){if(console.log("[Alibaba Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=(0,p.I)(e,u.k8.Qwen);if(o.error)return h.xk.json(o,{status:401});try{return await E(e)}catch(e){return console.error("[Alibaba] ",e),h.xk.json((0,d.B)(e))}}async function E(e){let t=new AbortController,o=`${e.nextUrl.pathname}`.replaceAll(u.L.Alibaba,""),r=N.alibabaUrl||u.x5;r.startsWith("http")||(r=`https://${r}`),r.endsWith("/")&&(r=r.slice(0,-1)),console.log("[Proxy] ",o),console.log("[Base Url]",r);let a=setTimeout(()=>{t.abort()},6e5),s=`${r}${o}`,n={headers:{"Content-Type":"application/json",Authorization:e.headers.get("Authorization")??"","X-DashScope-SSE":e.headers.get("X-DashScope-SSE")??"disable"},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(N.customModels&&e.body)try{let t=await e.text();n.body=t;let o=JSON.parse(t);if(f(N.customModels,o?.model,u.UT.Alibaba))return h.xk.json({error:!0,message:`you are not allowed to use ${o?.model} model`},{status:403})}catch(e){console.error("[Alibaba] filter",e)}try{let e=await fetch(s,n),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(a)}}let _=(0,c.g)();async function K(e,{params:t}){if(console.log("[Moonshot Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=(0,p.I)(e,u.k8.Moonshot);if(o.error)return h.xk.json(o,{status:401});try{return await L(e)}catch(e){return console.error("[Moonshot] ",e),h.xk.json((0,d.B)(e))}}async function L(e){let t=new AbortController,o=`${e.nextUrl.pathname}`.replaceAll(u.L.Moonshot,""),r=_.moonshotUrl||u.bP;r.startsWith("http")||(r=`https://${r}`),r.endsWith("/")&&(r=r.slice(0,-1)),console.log("[Proxy] ",o),console.log("[Base Url]",r);let a=setTimeout(()=>{t.abort()},6e5),s=`${r}${o}`,n={headers:{"Content-Type":"application/json",Authorization:e.headers.get("Authorization")??""},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(_.customModels&&e.body)try{let t=await e.text();n.body=t;let o=JSON.parse(t);if(f(_.customModels,o?.model,u.UT.Moonshot))return h.xk.json({error:!0,message:`you are not allowed to use ${o?.model} model`},{status:403})}catch(e){console.error("[Moonshot] filter",e)}try{let e=await fetch(s,n),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(a)}}async function D(e,{params:t}){if(console.log("[Stability] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=new AbortController,r=(0,c.g)(),a=r.stabilityUrl||u.rT;a.startsWith("http")||(a=`https://${a}`),a.endsWith("/")&&(a=a.slice(0,-1));let s=`${e.nextUrl.pathname}`.replaceAll("/api/stability/","");console.log("[Stability Proxy] ",s),console.log("[Stability Base Url]",a);let n=setTimeout(()=>{o.abort()},6e5),l=(0,p.I)(e,u.k8.Stability);if(l.error)return h.xk.json(l,{status:401});let i=(e.headers.get("Authorization")??"").trim().replaceAll("Bearer ","").trim()||r.stabilityApiKey;if(!i)return h.xk.json({error:!0,message:"missing STABILITY_API_KEY in server env vars"},{status:401});let d=`${a}/${s}`;console.log("[Stability Url] ",d);let y={headers:{"Content-Type":e.headers.get("Content-Type")||"multipart/form-data",Accept:e.headers.get("Accept")||"application/json",Authorization:`Bearer ${i}`},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:o.signal};try{let e=await fetch(d,y),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(n)}}let G=(0,c.g)();async function X(e,{params:t}){if(console.log("[Iflytek Route] params ",t),"OPTIONS"===e.method)return h.xk.json({body:"OK"},{status:200});let o=(0,p.I)(e,u.k8.Iflytek);if(o.error)return h.xk.json(o,{status:401});try{return await H(e)}catch(e){return console.error("[Iflytek] ",e),h.xk.json((0,d.B)(e))}}async function H(e){let t=new AbortController,o=`${e.nextUrl.pathname}`.replaceAll(u.L.Iflytek,""),r=G.iflytekUrl||u.pG;r.startsWith("http")||(r=`https://${r}`),r.endsWith("/")&&(r=r.slice(0,-1)),console.log("[Proxy] ",o),console.log("[Base Url]",r);let a=setTimeout(()=>{t.abort()},6e5),s=`${r}${o}`,n={headers:{"Content-Type":"application/json",Authorization:e.headers.get("Authorization")??""},method:e.method,body:e.body,redirect:"manual",duplex:"half",signal:t.signal};if(G.customModels&&e.body)try{let t=await e.text();n.body=t;let o=JSON.parse(t);if(f(G.customModels,o?.model,u.UT.Iflytek))return h.xk.json({error:!0,message:`you are not allowed to use ${o?.model} model`},{status:403})}catch(e){console.error("[Iflytek] filter",e)}try{let e=await fetch(s,n),t=new Headers(e.headers);return t.delete("www-authenticate"),t.set("X-Accel-Buffering","no"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}finally{clearTimeout(a)}}async function Y(e,{params:t}){let o=`/api/${t.provider}`;switch(console.log(`[${t.provider} Route] params `,t),o){case u.L.Azure:return T(e,{params:t});case u.L.Google:return O(e,{params:t});case u.L.Anthropic:return I(e,{params:t});case u.L.Baidu:return P(e,{params:t});case u.L.ByteDance:return z(e,{params:t});case u.L.Alibaba:return W(e,{params:t});case u.L.Moonshot:return K(e,{params:t});case u.L.Stability:return D(e,{params:t});case u.L.Iflytek:return X(e,{params:t});default:return A(e,{params:t})}}let J=Y,q=Y,F="edge",V=["arn1","bom1","cdg1","cle1","cpt1","dub1","fra1","gru1","hnd1","iad1","icn1","kix1","lhr1","pdx1","sfo1","sin1","syd1"],Q=new n.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/[provider]/[...path]/route",pathname:"/api/[provider]/[...path]",filename:"route",bundlePath:"app/api/[provider]/[...path]/route"},resolvedPagePath:"/Volumes/D/github/ChatGPT-Next-Web/app/api/[provider]/[...path]/route.ts",nextConfigOutput:"standalone",userland:r}),{requestAsyncStorage:Z,staticGenerationAsyncStorage:ee,serverHooks:et,headerHooks:eo,staticGenerationBailout:er}=Q,ea="/api/[provider]/[...path]/route";function es(){return(0,i.XH)({serverHooks:et,staticGenerationAsyncStorage:ee})}let en=a,el=s.a.wrap(Q)}},e=>{var t=t=>e(e.s=t);e.O(0,[297,45,276],()=>t(5842));var o=e.O();(_ENTRIES="undefined"==typeof _ENTRIES?{}:_ENTRIES)["middleware_app/api/[provider]/[...path]/route"]=o}]);
//# sourceMappingURL=route.js.map