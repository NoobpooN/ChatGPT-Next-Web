{"version":3,"file":"app/api/baidu/[...path]/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/utils/baidu.ts","webpack://_N_E/./app/api/baidu/[...path]/route.ts","webpack://_N_E/./app/api/baidu/[...path]/route.ts?7cbf","webpack://_N_E/?4b3d","webpack://_N_E/<anon>"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","import { BAIDU_OATUH_URL } from \"../constant\";\n/**\n * 使用 AK，SK 生成鉴权签名（Access Token）\n * @return 鉴权签名信息\n */\nexport async function getAccessToken(\n  clientId: string,\n  clientSecret: string,\n): Promise<{\n  access_token: string;\n  expires_in: number;\n  error?: number;\n}> {\n  const res = await fetch(\n    `${BAIDU_OATUH_URL}?grant_type=client_credentials&client_id=${clientId}&client_secret=${clientSecret}`,\n    {\n      method: \"POST\",\n      mode: \"cors\",\n    },\n  );\n  const resJson = await res.json();\n  return resJson;\n}\n","import { getServerSideConfig } from \"@/app/config/server\";\nimport {\n  BAIDU_BASE_URL,\n  ApiPath,\n  ModelProvider,\n  BAIDU_OATUH_URL,\n  ServiceProvider,\n} from \"@/app/constant\";\nimport { prettyObject } from \"@/app/utils/format\";\nimport { NextRequest, NextResponse } from \"next/server\";\nimport { auth } from \"@/app/api/auth\";\nimport { isModelAvailableInServer } from \"@/app/utils/model\";\nimport { getAccessToken } from \"@/app/utils/baidu\";\n\nconst serverConfig = getServerSideConfig();\n\nasync function handle(\n  req: NextRequest,\n  { params }: { params: { path: string[] } },\n) {\n  console.log(\"[Baidu Route] params \", params);\n\n  if (req.method === \"OPTIONS\") {\n    return NextResponse.json({ body: \"OK\" }, { status: 200 });\n  }\n\n  const authResult = auth(req, ModelProvider.Ernie);\n  if (authResult.error) {\n    return NextResponse.json(authResult, {\n      status: 401,\n    });\n  }\n\n  if (!serverConfig.baiduApiKey || !serverConfig.baiduSecretKey) {\n    return NextResponse.json(\n      {\n        error: true,\n        message: `missing BAIDU_API_KEY or BAIDU_SECRET_KEY in server env vars`,\n      },\n      {\n        status: 401,\n      },\n    );\n  }\n\n  try {\n    const response = await request(req);\n    return response;\n  } catch (e) {\n    console.error(\"[Baidu] \", e);\n    return NextResponse.json(prettyObject(e));\n  }\n}\n\nexport const GET = handle;\nexport const POST = handle;\n\nexport const runtime = \"edge\";\nexport const preferredRegion = [\n  \"arn1\",\n  \"bom1\",\n  \"cdg1\",\n  \"cle1\",\n  \"cpt1\",\n  \"dub1\",\n  \"fra1\",\n  \"gru1\",\n  \"hnd1\",\n  \"iad1\",\n  \"icn1\",\n  \"kix1\",\n  \"lhr1\",\n  \"pdx1\",\n  \"sfo1\",\n  \"sin1\",\n  \"syd1\",\n];\n\nasync function request(req: NextRequest) {\n  const controller = new AbortController();\n\n  let path = `${req.nextUrl.pathname}`.replaceAll(ApiPath.Baidu, \"\");\n\n  let baseUrl = serverConfig.baiduUrl || BAIDU_BASE_URL;\n\n  if (!baseUrl.startsWith(\"http\")) {\n    baseUrl = `https://${baseUrl}`;\n  }\n\n  if (baseUrl.endsWith(\"/\")) {\n    baseUrl = baseUrl.slice(0, -1);\n  }\n\n  console.log(\"[Proxy] \", path);\n  console.log(\"[Base Url]\", baseUrl);\n\n  const timeoutId = setTimeout(\n    () => {\n      controller.abort();\n    },\n    10 * 60 * 1000,\n  );\n\n  const { access_token } = await getAccessToken(\n    serverConfig.baiduApiKey as string,\n    serverConfig.baiduSecretKey as string,\n  );\n  const fetchUrl = `${baseUrl}${path}?access_token=${access_token}`;\n\n  const fetchOptions: RequestInit = {\n    headers: {\n      \"Content-Type\": \"application/json\",\n    },\n    method: req.method,\n    body: req.body,\n    redirect: \"manual\",\n    // @ts-ignore\n    duplex: \"half\",\n    signal: controller.signal,\n  };\n\n  // #1815 try to refuse some request to some models\n  if (serverConfig.customModels && req.body) {\n    try {\n      const clonedBody = await req.text();\n      fetchOptions.body = clonedBody;\n\n      const jsonBody = JSON.parse(clonedBody) as { model?: string };\n\n      // not undefined and is false\n      if (\n        isModelAvailableInServer(\n          serverConfig.customModels,\n          jsonBody?.model as string,\n          ServiceProvider.Baidu as string,\n        )\n      ) {\n        return NextResponse.json(\n          {\n            error: true,\n            message: `you are not allowed to use ${jsonBody?.model} model`,\n          },\n          {\n            status: 403,\n          },\n        );\n      }\n    } catch (e) {\n      console.error(`[Baidu] filter`, e);\n    }\n  }\n  try {\n    const res = await fetch(fetchUrl, fetchOptions);\n\n    // to prevent browser prompt for credentials\n    const newHeaders = new Headers(res.headers);\n    newHeaders.delete(\"www-authenticate\");\n    // to disable nginx buffering\n    newHeaders.set(\"X-Accel-Buffering\", \"no\");\n\n    return new Response(res.body, {\n      status: res.status,\n      statusText: res.statusText,\n      headers: newHeaders,\n    });\n  } finally {\n    clearTimeout(timeoutId);\n  }\n}\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"/Volumes/D/github/ChatGPT-Next-Web/app/api/baidu/[...path]/route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"standalone\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/baidu/[...path]/route\",\n        pathname: \"/api/baidu/[...path]\",\n        filename: \"route\",\n        bundlePath: \"app/api/baidu/[...path]/route\"\n    },\n    resolvedPagePath: \"/Volumes/D/github/ChatGPT-Next-Web/app/api/baidu/[...path]/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, headerHooks, staticGenerationBailout } = routeModule;\nconst originalPathname = \"/api/baidu/[...path]/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, headerHooks, staticGenerationBailout, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fbaidu%2F%5B...path%5D%2Froute&page=%2Fapi%2Fbaidu%2F%5B...path%5D%2Froute&pagePath=private-next-app-dir%2Fapi%2Fbaidu%2F%5B...path%5D%2Froute.ts&appDir=%2FVolumes%2FD%2Fgithub%2FChatGPT-Next-Web%2Fapp&appPaths=%2Fapi%2Fbaidu%2F%5B...path%5D%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=standalone&preferredRegion=arn1&preferredRegion=bom1&preferredRegion=cdg1&preferredRegion=cle1&preferredRegion=cpt1&preferredRegion=dub1&preferredRegion=fra1&preferredRegion=gru1&preferredRegion=hnd1&preferredRegion=iad1&preferredRegion=icn1&preferredRegion=kix1&preferredRegion=lhr1&preferredRegion=pdx1&preferredRegion=sfo1&preferredRegion=sin1&preferredRegion=syd1&middlewareConfig=e30%3D!private-next-app-dir/api/baidu/[...path]/route.ts?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map"],"names":["module","exports","require","getAccessToken","clientId","clientSecret","res","fetch","BAIDU_OATUH_URL","method","mode","json","serverConfig","getServerSideConfig","handle","req","params","console","log","NextResponse","body","status","authResult","auth","ModelProvider","Ernie","error","baiduApiKey","baiduSecretKey","message","request","e","prettyObject","GET","POST","runtime","preferredRegion","controller","AbortController","path","nextUrl","pathname","replaceAll","ApiPath","Baidu","baseUrl","baiduUrl","BAIDU_BASE_URL","startsWith","endsWith","slice","timeoutId","setTimeout","abort","access_token","fetchUrl","fetchOptions","headers","redirect","duplex","signal","customModels","clonedBody","text","jsonBody","JSON","parse","isModelAvailableInServer","model","ServiceProvider","newHeaders","Headers","delete","set","Response","statusText","clearTimeout","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","headerHooks","staticGenerationBailout","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fbaidu_2F_5B_path_5D_2Froute_ts_page_2Fapi_2Fbaidu_2F_5B_path_5D_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGYmFpZHUlMkYlNUIuLi5wYXRoJTVEJTJGcm91dGUmcGFnZT0lMkZhcGklMkZiYWlkdSUyRiU1Qi4uLnBhdGglNUQlMkZyb3V0ZSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmJhaWR1JTJGJTVCLi4ucGF0aCU1RCUyRnJvdXRlLnRzJmFwcERpcj0lMkZWb2x1bWVzJTJGRCUyRmdpdGh1YiUyRkNoYXRHUFQtTmV4dC1XZWIlMkZhcHAmYXBwUGF0aHM9JTJGYXBpJTJGYmFpZHUlMkYlNUIuLi5wYXRoJTVEJTJGcm91dGUmcGFnZUV4dGVuc2lvbnM9dHN4JnBhZ2VFeHRlbnNpb25zPXRzJnBhZ2VFeHRlbnNpb25zPWpzeCZwYWdlRXh0ZW5zaW9ucz1qcyZiYXNlUGF0aD0mYXNzZXRQcmVmaXg9Jm5leHRDb25maWdPdXRwdXQ9c3RhbmRhbG9uZSZwcmVmZXJyZWRSZWdpb249YXJuMSZwcmVmZXJyZWRSZWdpb249Ym9tMSZwcmVmZXJyZWRSZWdpb249Y2RnMSZwcmVmZXJyZWRSZWdpb249Y2xlMSZwcmVmZXJyZWRSZWdpb249Y3B0MSZwcmVmZXJyZWRSZWdpb249ZHViMSZwcmVmZXJyZWRSZWdpb249ZnJhMSZwcmVmZXJyZWRSZWdpb249Z3J1MSZwcmVmZXJyZWRSZWdpb249aG5kMSZwcmVmZXJyZWRSZWdpb249aWFkMSZwcmVmZXJyZWRSZWdpb249aWNuMSZwcmVmZXJyZWRSZWdpb249a2l4MSZwcmVmZXJyZWRSZWdpb249bGhyMSZwcmVmZXJyZWRSZWdpb249cGR4MSZwcmVmZXJyZWRSZWdpb249c2ZvMSZwcmVmZXJyZWRSZWdpb249c2luMSZwcmVmZXJyZWRSZWdpb249c3lkMSZtaWRkbGV3YXJlQ29uZmlnPWUzMCUzRCE_3D_nextConfigOutput_standalone_preferredRegion_arn1_preferredRegion_bom1_preferredRegion_cdg1_preferredRegion_cle1_preferredRegion_cpt1_preferredRegion_dub1_preferredRegion_fra1_preferredRegion_gru1_preferredRegion_hnd1_preferredRegion_iad1_preferredRegion_icn1_preferredRegion_kix1_preferredRegion_lhr1_preferredRegion_pdx1_preferredRegion_sfo1_preferredRegion_sin1_preferredRegion_syd1_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap"],"sourceRoot":""}